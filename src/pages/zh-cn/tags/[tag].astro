---
import DynamicTagLayout from '@layouts/DynamicTagLayout.astro'

import { queryAllLabels, queryPostsFromLabel } from '@services'

import type { InferGetStaticPropsType, InferGetStaticParamsType } from 'astro'

export async function getStaticPaths() {
  const {
    repository: {
      labels: { nodes },
    },
  } = await queryAllLabels()

  const labels = nodes.map(v => v.name)

  const posts = await Promise.all(labels.map(label => queryPostsFromLabel({ label })))

  return posts.map(item => {
    const issues = item.repository.label.issues.nodes
    const tag = item.repository.label.name
    return {
      params: {
        tag,
      },
      props: {
        posts: issues,
      },
    }
  })
}

const { posts } = Astro.props as InferGetStaticPropsType<typeof getStaticPaths>
const { tag } = Astro.params as InferGetStaticParamsType<typeof getStaticPaths>
---

<DynamicTagLayout posts={posts} tag={tag} />
